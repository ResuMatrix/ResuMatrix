pipeline {
    agent any

    environment {
        // Environment variables from Jenkins credentials
        GOOGLE_APPLICATION_CREDENTIALS = credentials('gcp-credentials')
        GCP_BUCKET_NAME = "resumatrix-embeddings"
        GCP_PROJECT_ID = "awesome-nimbus-452221-v2"
        MLFLOW_TRACKING_URI = "http://mlflow:5000"
        ARTIFACT_REGISTRY_REPO = "us-east1-docker.pkg.dev/awesome-nimbus-452221-v2/resume-fit-supervised/xgboost_and_cosine_similarity"
        MODEL_TAG = "xgboost-model-${BUILD_NUMBER}"
    }

    triggers {
        // Poll GCS bucket for changes every hour
        pollSCM('H * * * *')
    }

    stages {
        stage('Setup') {
            steps {
                sh '''
                    python3 -m venv venv
                    . venv/bin/activate
                    pip install --upgrade pip
                    pip install -r retraining_pipeline/requirements.txt
                    mkdir -p data model_registry
                '''
            }
        }

        stage('Download from GCS') {
            steps {
                sh '''
                    . venv/bin/activate
                    python retraining_pipeline/download_from_gcs.py
                '''
            }
        }

        stage('Run Retraining') {
            steps {
                sh '''
                    . venv/bin/activate
                    python retraining_pipeline/run_retraining.py
                '''
            }
        }

        stage('Final Processing') {
            when {
                // Only run this stage if a new model was saved
                expression { return fileExists('model_registry/new_model_saved.txt') }
            }
            steps {
                sh '''
                    # Run the non-Docker script
                    cd retraining_pipeline
                    chmod +x run_without_docker.sh
                    ./run_without_docker.sh
                '''
            }
        }
    }

    post {
        always {
            echo 'Cleaning up...'
        }
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed!'
        }
    }
}
